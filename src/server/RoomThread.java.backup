package server;

import java.util.*;

/**
 * â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
 * ROOM THREAD - Xá»¬ LÃ LOGIC PHÃ’NG CHÆ I & GAME
 * â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
 * 
 * Má»—i phÃ²ng cÃ³ 1 RoomThread riÃªng xá»­ lÃ½:
 * - Quáº£n lÃ½ ngÆ°á»i chÆ¡i (thÃªm/xÃ³a, host, ready status)
 * - Logic game (rÃºt bÃ i, turn-based, timeout)
 * - TÃ­nh Ä‘iá»ƒm & xáº¿p háº¡ng
 * 
 * â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
 * ğŸ“¡ PROTOCOL MESSAGES Gá»¬I ÄI (Server â†’ Client):
 * â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
 * 
 * MESSAGES PHÃ’NG CHÆ :
 * â€¢ ROOM_UPDATE|roomName|hostIndex|player1,player2,player3,...
 * â†’ Cáº­p nháº­t danh sÃ¡ch ngÆ°á»i trong phÃ²ng
 * â†’ Parse: GameScreen.java dÃ²ng 382-390
 * 
 * â€¢ READY_STATUS|user1:true|user2:false|user3:true|...
 * â†’ Tráº¡ng thÃ¡i sáºµn sÃ ng cá»§a tá»«ng ngÆ°á»i (guest only, host luÃ´n ready)
 * â†’ Parse: GameScreen.java dÃ²ng 406-444
 * 
 * â€¢ YOU_ARE_HOST
 * â†’ ThÃ´ng bÃ¡o báº¡n trá»Ÿ thÃ nh host (khi host cÅ© rá»i)
 * â†’ Parse: GameScreen.java dÃ²ng 369-380
 * 
 * â€¢ KICKED;reason
 * â†’ Báº¡n bá»‹ host kick khá»i phÃ²ng
 * 
 * MESSAGES TRONG GAME:
 * â€¢ GAME_START;RoomName
 * â†’ VÃ¡n bÃ i báº¯t Ä‘áº§u, reset táº¥t cáº£
 * â†’ Parse: GameScreen.java dÃ²ng 222-253
 * 
 * â€¢ YOUR_TURN
 * â†’ Äáº¿n lÆ°á»£t báº¡n rÃºt bÃ i (10 giÃ¢y timeout)
 * 
 * â€¢ WAIT
 * â†’ ChÆ°a Ä‘áº¿n lÆ°á»£t, chá» ngÆ°á»i khÃ¡c
 * 
 * â€¢ DRAW;Kâ™ 
 * â†’ Báº¡n rÃºt Ä‘Æ°á»£c lÃ¡ bÃ i (format: Rank+Suit)
 * â†’ Rank: A,2-10,J,Q,K | Suit: â™ â™¥â™¦â™£
 * â†’ Parse: GameScreen.java dÃ²ng 568-579
 * 
 * â€¢ SHOW_HANDS_ALL|player1=Kâ™ ,Qâ™ ,Jâ™ |player2=Aâ™¥,5â™¦,3â™£|...
 * â†’ Láº­t táº¥t cáº£ bÃ i cá»§a má»i ngÆ°á»i lÃªn (khi Ä‘á»§ 3 lÃ¡)
 * â†’ Parse: GameScreen.java dÃ²ng 293-339
 * 
 * â€¢ HAND_RANKS|player1:4:Straight Flush:530|player2:1:HighCard:7|...
 * â†’ Xáº¿p loáº¡i tay bÃ i cá»§a tá»«ng ngÆ°á»i
 * â†’ Category: 5=ThreeOfAKind, 4=StraightFlush, 3=Straight, 2=Flush, 1=HighCard
 * â†’ Äiá»ƒm: chá»‰ hiá»‡n cho HighCard (modulo 10), loáº¡i khÃ¡c áº©n composite score
 * â†’ Parse: GameScreen.java dÃ²ng 472-500
 * 
 * â€¢ WINNER player1 tay=Straight Flush
 * â†’ ThÃ´ng bÃ¡o ngÆ°á»i tháº¯ng
 * â†’ Parse: GameScreen.java dÃ²ng 278-292
 * 
 * â€¢ RANKING|player1:15:+3|player2:8:-1|player3:5:-1|...
 * â†’ Báº£ng xáº¿p háº¡ng káº¿t quáº£ vÃ¡n (thá»© tá»± tá»« cao xuá»‘ng tháº¥p theo bÃ i)
 * â†’ Format: username:Ä‘iá»ƒm_tá»•ng:Ä‘iá»ƒm_thay_Ä‘á»•i
 * â†’ Parse: GameScreen.java dÃ²ng 518-545
 * 
 * â€¢ END;RoomName
 * â†’ VÃ¡n káº¿t thÃºc, sáºµn sÃ ng cho vÃ¡n má»›i
 * â†’ âš ï¸ BÃ i KHÃ”NG xÃ³a á»Ÿ Ä‘Ã¢y, chá»‰ xÃ³a khi GAME_START
 * 
 * â€¢ ELIMINATED;Timeout - khÃ´ng rÃºt trong 10s. Báº¡n bá»‹ trá»« 1 Ä‘iá»ƒm!
 * â†’ Báº¡n bá»‹ loáº¡i do timeout, kick khá»i phÃ²ng
 * 
 * â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
 * ğŸ“¨ PROTOCOL MESSAGES NHáº¬N VÃ€O (Client â†’ Server):
 * â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
 * 
 * Xá»­ lÃ½ bá»Ÿi ClientHandler.java:
 * â€¢ READY;true hoáº·c READY;false
 * â†’ Guest báº­t/táº¯t tráº¡ng thÃ¡i sáºµn sÃ ng
 * 
 * â€¢ START_GAME
 * â†’ Host báº¯t Ä‘áº§u game (cáº§n Ä‘á»§ ngÆ°á»i & táº¥t cáº£ ready)
 * 
 * â€¢ DRAW_CARD
 * â†’ NgÆ°á»i chÆ¡i rÃºt bÃ i (pháº£i Ä‘Ãºng lÆ°á»£t)
 * 
 * â€¢ KICK_PLAYER;targetUsername
 * â†’ Host kick ngÆ°á»i chÆ¡i
 * 
 * â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
 * ğŸ® LOGIC GAME:
 * â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
 * 
 * 1. Má»—i ngÆ°á»i rÃºt tá»‘i Ä‘a 3 lÃ¡ (turn-based)
 * 2. Timeout 10 giÃ¢y/lÆ°á»£t â†’ -1 Ä‘iá»ƒm, kick khá»i phÃ²ng
 * 3. Xáº¿p háº¡ng bÃ i: ThreeOfAKind > StraightFlush > Straight > Flush > HighCard
 * 4. Äiá»ƒm ngÆ°á»i tháº¯ng = (tá»•ng sá»‘ ngÆ°á»i bao gá»“m timeout - 1)
 * 5. NgÆ°á»i timeout Ä‘Ã£ bá»‹ -1 ngay, khÃ´ng trá»« thÃªm á»Ÿ cuá»‘i
 * 6. Káº¿t quáº£ xáº¿p theo bÃ i máº¡nh nháº¥t (khÃ´ng theo Ä‘iá»ƒm tÃ­ch lÅ©y)
 * 
 * â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
 * ğŸ¨ CHÃš Ã CHO GIAO DIá»†N:
 * â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
 * 
 * âš ï¸ ÄÃ‚Y LÃ€ Báº¢N DEMO LOGIC - Cáº¦N Cáº¢I THIá»†N GIAO DIá»†N!
 * 
 * Logic game Ä‘Ã£ hoÃ n chá»‰nh, chá»‰ cáº§n wrap UI Ä‘áº¹p hÆ¡n:
 * - Animation rÃºt bÃ i
 * - Effect láº­t bÃ i
 * - Timer Ä‘áº¿m ngÆ°á»£c Ä‘áº¹p hÆ¡n
 * - Highlight ngÆ°á»i tháº¯ng vá»›i effect
 * - Sound effects (rÃºt bÃ i, win, lose, timeout)
 * 
 * â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
 */
public class RoomThread extends Thread {
    private static final int MAX_PLAYERS = 6; // Giá»›i háº¡n tá»‘i Ä‘a 6 ngÆ°á»i
    private String roomName;
    private List<ClientHandler> players = Collections.synchronizedList(new ArrayList<>());
    private Map<String, RoomThread> rooms;
    private Database db;
    private Integer matchId; // ID vÃ¡n Ä‘áº¥u trong DB

    // Room management
    private int hostIndex = 0; // Index cá»§a chá»§ phÃ²ng
    private boolean gameStarted = false;
    private Map<String, Boolean> playerReady = new HashMap<>(); // Tráº¡ng thÃ¡i sáºµn sÃ ng cá»§a tá»«ng ngÆ°á»i
    
    // Delegate game logic & turn management
    private GameLogic gameLogic = new GameLogic();
    private TurnManager turnManager = new TurnManager(gameLogic);

    public RoomThread(String name, Map<String, RoomThread> rooms, Database db) {
        this.roomName = name;
        this.rooms = rooms;
        this.db = db;
        this.turnManager.setRoomThread(this);
    }

    public synchronized boolean isFull() {
        return players.size() >= MAX_PLAYERS;
    }

    public synchronized int getPlayerCount() {
        return players.size();
    }

    public synchronized void addPlayer(ClientHandler p) {
        if (players.size() >= MAX_PLAYERS) {
            p.sendMessage("ROOM_FULL");
            return;
        }
        players.add(p);
        p.setStatus("busy");
        playerReady.put(p.username, false); // Máº·c Ä‘á»‹nh chÆ°a sáºµn sÃ ng
        broadcastRoomUpdate();
        broadcastReadyStatus(); // Broadcast ngay Ä‘á»ƒ client biáº¿t tráº¡ng thÃ¡i ready
    }

    public synchronized void removePlayer(ClientHandler p) {
        int removedIndex = players.indexOf(p);
        players.remove(p);
        p.setStatus("free");
        playerReady.remove(p.username);

        // Náº¿u ngÆ°á»i bá»‹ remove lÃ  host, chá»n host má»›i
        if (removedIndex == hostIndex && !players.isEmpty()) {
            hostIndex = 0; // Host má»›i lÃ  ngÆ°á»i Ä‘áº§u tiÃªn
            players.get(0).sendMessage("YOU_ARE_HOST");
        } else if (removedIndex < hostIndex) {
            // Náº¿u xÃ³a ngÆ°á»i trÆ°á»›c host, giáº£m hostIndex Ä‘á»ƒ giá»¯ Ä‘Ãºng vá»‹ trÃ­
            hostIndex--;
        }

        // Cáº­p nháº­t currentTurn náº¿u cáº§n
        if (gameStarted && !players.isEmpty()) {
            int currentTurn = turnManager.getCurrentTurn();
            if (currentTurn >= players.size()) {
                turnManager.adjustTurnAfterRemoval(currentTurn, players.size());
            }
            turnManager.notifyCurrentTurn(players);
        }

        // LUÃ”N broadcast ROOM_UPDATE khi cÃ³ ngÆ°á»i rá»i phÃ²ng
        if (!players.isEmpty()) {
            broadcastRoomUpdate();
            broadcastReadyStatus(); // Cáº­p nháº­t tráº¡ng thÃ¡i ready sau khi ngÆ°á»i rá»i
        }

        if (players.isEmpty()) {
            turnManager.cancelTimer();
            rooms.remove(roomName);
            this.interrupt();
            // Sau khi phÃ²ng bá»‹ xÃ³a (trá»‘ng) -> broadcast danh sÃ¡ch phÃ²ng
            Server.broadcastRoomsList();
        } else {
            // CÃ³ ngÆ°á»i rá»i nhÆ°ng phÃ²ng váº«n cÃ²n ngÆ°á»i -> cáº­p nháº­t danh sÃ¡ch phÃ²ng
            Server.broadcastRoomsList();
        }
    }

    public int getPlayerIndex(ClientHandler p) {
        return players.indexOf(p);
    }

    public void run() {
        System.out.println("ğŸ§© PhÃ²ng " + roomName + " Ä‘Ã£ sáºµn sÃ ng.");
    }

    public synchronized void setPlayerReady(String username, boolean ready) {
        playerReady.put(username, ready);
        System.out.println("ğŸ”´ [" + roomName + "] " + username + " ready=" + ready);
        System.out.println("   Ready map: " + playerReady);
        System.out.println("   All ready? " + allPlayersReady());
        broadcastReadyStatus();
    }

    public synchronized boolean allPlayersReady() {
        if (players.size() < 2)
            return false; // Cáº§n Ã­t nháº¥t 2 ngÆ°á»i
        // Host luÃ´n sáºµn sÃ ng, chá»‰ check cÃ¡c ngÆ°á»i khÃ¡c
        for (ClientHandler p : players) {
            int idx = players.indexOf(p);
            if (idx != hostIndex) { // Bá» qua host
                if (!playerReady.getOrDefault(p.username, false)) {
                    return false;
                }
            }
        }
        return true;
    }

    private synchronized void broadcastReadyStatus() {
        // Format: READY_STATUS|user1:true|user2:false|...
        StringBuilder sb = new StringBuilder("READY_STATUS|");
        for (ClientHandler p : players) {
            boolean ready = playerReady.getOrDefault(p.username, false);
            sb.append(p.username).append(":").append(ready).append("|");
        }
        String msg = sb.toString();
        System.out.println("ğŸ“¡ Broadcasting: " + msg);
        broadcast(msg);
    }

    public void startGame() {
        if (players.size() < 2) {
            broadcast("SYSTEM ChÆ°a Ä‘á»§ ngÆ°á»i chÆ¡i Ä‘á»ƒ báº¯t Ä‘áº§u!");
            return;
        }
        if (!allPlayersReady()) {
            broadcast("SYSTEM ChÆ°a Ä‘á»§ ngÆ°á»i sáºµn sÃ ng!");
            return;
        }
        gameStarted = true;
        
        // Khá»Ÿi táº¡o game logic & turn manager
        gameLogic.initializeNewRound(players);
        turnManager.initializeTurn(hostIndex);
        
        playerReady.clear(); // Reset ready sau khi báº¯t Ä‘áº§u
        synchronized (players) {
            for (ClientHandler c : players) {
                c.setStatus("playing");
            }
        }
        // ThÃ´ng bÃ¡o báº¯t Ä‘áº§u vÃ¡n; UI sáº½ reset tá»« GAME_START
        broadcast("GAME_START;" + roomName);
        broadcast("SYSTEM VÃ¡n bÃ i báº¯t Ä‘áº§u! RÃºt theo lÆ°á»£t, má»—i ngÆ°á»i tá»‘i Ä‘a 3 lÃ¡.");
        broadcastRoomUpdate();
        turnManager.notifyCurrentTurn(players);
        turnManager.startTurnTimer();
        // Táº¡o má»›i báº£n ghi Matches
        matchId = db != null ? db.createMatch(players.size()) : null;
        System.out.println("ğŸ® " + roomName + " báº¯t Ä‘áº§u, MatchID=" + matchId + ", khÃ´ng chia bÃ i ban Ä‘áº§u.");
    }

    // legacy shuffle removed; using Deck instead

    public synchronized void playerDrawCard(int playerID) {
        // Giá»¯ method cÅ© (khÃ´ng dÃ¹ng ná»¯a) Ä‘á»ƒ tÆ°Æ¡ng thÃ­ch náº¿u cÃ²n tham chiáº¿u
        if (!gameStarted)
            return;
        int currentTurn = turnManager.getCurrentTurn();
        if (playerID != currentTurn) {
            if (playerID >= 0 && playerID < players.size())
                players.get(playerID).sendMessage("NOT_YOUR_TURN");
            return;
        }
        // Chuyá»ƒn sang phÆ°Æ¡ng thá»©c má»›i dá»±a trÃªn ClientHandler
        drawCard(players.get(playerID));
    }

    // RÃºt bÃ i theo lÆ°á»£t má»›i: má»—i ngÆ°á»i rÃºt thÃªm tá»‘i Ä‘a 3 lÃ¡ Ä‘á»ƒ Ä‘áº¡t 6 lÃ¡ tá»•ng
    public synchronized void drawCard(ClientHandler player) {
        if (!gameStarted || players.isEmpty())
            return;
        int idx = players.indexOf(player);
        if (idx != currentTurn) {
            player.sendMessage("NOT_YOUR_TURN");
            return;
        }
        // Táº¡o tay bÃ i náº¿u chÆ°a cÃ³
        Hand hand = playerHands.computeIfAbsent(player.username, k -> new Hand());
        int cnt = drawCounts.getOrDefault(player.username, 0);
        if (cnt >= 3) {
            player.sendMessage("SYSTEM Báº¡n Ä‘Ã£ rÃºt Ä‘á»§ 3 lÃ¡!");
            nextTurn();
            return;
        }
        Card drawn = deck.drawCard();
        if (drawn == null) {
            player.sendMessage("SYSTEM Háº¿t bÃ i!");
            nextTurn();
            return;
        }
        hand.addCard(drawn);
        drawCounts.put(player.username, cnt + 1);
        // Gá»­i lÃ¡ rÃºt cho ngÆ°á»i chÆ¡i Ä‘Ã³
        player.sendMessage("DRAW;" + drawn.toString());
        System.out.println("ğŸ‚  " + player.username + " rÃºt: " + drawn + " (" + (cnt + 1) + "/3)");
        // Má»—i lÆ°á»£t chá»‰ rÃºt 1 lÃ¡ -> chuyá»ƒn lÆ°á»£t (ngÆ°á»£c chiá»u kim Ä‘á»“ng há»“)
        nextTurn();
    }

    private void broadcast(String msg) {
        for (ClientHandler p : players)
            p.sendMessage(msg);
    }

    // Chuyá»ƒn sang lÆ°á»£t tiáº¿p theo (ngÆ°á»£c chiá»u kim Ä‘á»“ng há»“)
    private synchronized void nextTurn() {
        if (players.isEmpty()) {
            endGame();
            return;
        }
        
        boolean hasNextTurn = turnManager.nextTurn(players);
        if (!hasNextTurn) {
            endGame();
            return;
        }
        
        turnManager.notifyCurrentTurn(players);
        turnManager.startTurnTimer();
    }

    // Xá»­ lÃ½ timeout - kick ngÆ°á»i chÆ¡i
    private synchronized void handleTimeout() {
        if (!gameStarted || players.isEmpty())
            return;
        ClientHandler timedOut = players.get(currentTurn);
        String username = timedOut.username;
        System.out.println("â° Timeout! Loáº¡i: " + username);

        // Trá»« Ä‘iá»ƒm cho ngÆ°á»i timeout
        Server.playerScores.putIfAbsent(username, 0);
        Server.playerScores.put(username, Server.playerScores.get(username) - 1);

        // Cáº­p nháº­t vÃ o database
        if (db != null) {
            Integer pid = db.getPlayerId(username);
            if (pid != null) {
                db.updateTotalPoints(pid, -1);
            }
        }

        // LÆ°u vÃ o danh sÃ¡ch timeout
        timeoutPlayers.add(username);

        // ThÃ´ng bÃ¡o bá»‹ loáº¡i
        timedOut.sendMessage("ELIMINATED;Timeout - khÃ´ng rÃºt trong 10s. Báº¡n bá»‹ trá»« 1 Ä‘iá»ƒm!");
        // Loáº¡i khá»i phÃ²ng
        players.remove(currentTurn);
        playerHands.remove(username);
        drawCounts.remove(username);
        timedOut.setStatus("free");
        timedOut.resetCurrentRoom();
        // Cáº­p nháº­t host náº¿u cáº§n
        if (currentTurn == hostIndex && !players.isEmpty()) {
            hostIndex = 0;
            players.get(0).sendMessage("YOU_ARE_HOST");
        } else if (hostIndex > currentTurn) {
            hostIndex--;
        }
        // Äiá»u chá»‰nh currentTurn
        if (currentTurn >= players.size())
            currentTurn = players.size() - 1;

        // Cáº­p nháº­t lobby
        Server.broadcastPlayerList();
        Server.broadcastRoomsList();

        if (players.isEmpty()) {
            endGame();
            return;
        }
        // Náº¿u chá»‰ cÃ²n 1 ngÆ°á»i => káº¿t thÃºc ngay
        if (players.size() == 1) {
            endGame();
            return;
        }
        // Tiáº¿p tá»¥c lÆ°á»£t (ngÆ°á»£c chiá»u)
        broadcastRoomUpdate();
        nextTurn();
    }

    // Broadcast danh sÃ¡ch ngÆ°á»i chÆ¡i
    private synchronized void broadcastRoomUpdate() {
        StringBuilder sb = new StringBuilder("ROOM_UPDATE|");
        sb.append(roomName).append("|");
        sb.append(hostIndex).append("|");
        for (int i = 0; i < players.size(); i++) {
            sb.append(players.get(i).username);
            if (i < players.size() - 1) {
                sb.append(",");
            }
        }
        broadcast(sb.toString());
    }

    // Gá»­i ROOM_UPDATE chá»‰ cho 1 client (dÃ¹ng khi client má»›i vÃ o phÃ²ng cáº§n snapshot)
    public synchronized void sendRoomUpdateTo(ClientHandler target) {
        StringBuilder sb = new StringBuilder("ROOM_UPDATE|");
        sb.append(roomName).append("|");
        sb.append(hostIndex).append("|");
        for (int i = 0; i < players.size(); i++) {
            sb.append(players.get(i).username);
            if (i < players.size() - 1) {
                sb.append(",");
            }
        }
        target.sendMessage(sb.toString());
    }

    // Káº¿t thÃºc game
    private synchronized void endGame() {
        gameStarted = false;
        if (turnTimer != null) {
            turnTimer.cancel();
            turnTimer = null;
        }

        // TrÆ°á»ng há»£p Ä‘áº·c biá»‡t: Chá»‰ cÃ²n 1 ngÆ°á»i (nhá»¯ng ngÆ°á»i khÃ¡c timeout)
        if (players.size() == 1 && timeoutPlayers.size() > 0) {
            ClientHandler lastPlayer = players.get(0);
            String winner = lastPlayer.username;
            int totalParticipants = 1 + timeoutPlayers.size();
            int winnerPoints = totalParticipants - 1;

            // Cáº­p nháº­t Ä‘iá»ƒm tháº¯ng
            Server.playerScores.putIfAbsent(winner, 0);
            Server.playerScores.put(winner, Server.playerScores.get(winner) + winnerPoints);

            // Persist to DB
            if (db != null) {
                Integer winId = db.getPlayerId(winner);
                if (winId != null) {
                    db.updateTotalPoints(winId, winnerPoints);
                }
            }

            // Broadcast thÃ´ng bÃ¡o
            broadcast("WINNER " + winner + " - Chiáº¿n tháº¯ng do Ä‘á»‘i thá»§ timeout!");
            broadcast("RANKING|" + winner + ":" + Server.playerScores.get(winner) + ":+" + winnerPoints + "|");
            broadcast("END;" + roomName);

            // Reset tráº¡ng thÃ¡i
            synchronized (players) {
                lastPlayer.setStatus("busy");
                playerReady.put(winner, false);
            }
            playerHands.clear();
            drawCounts.clear();
            broadcastReadyStatus();
            Server.broadcastPlayerList();

            System.out.println("ğŸ " + winner + " tháº¯ng do Ä‘á»‘i thá»§ timeout, nháº­n +" + winnerPoints + " Ä‘iá»ƒm.");
            return;
        }

        // Thu tháº­p tay bÃ i & Ä‘iá»ƒm modulo (chá»‰ HighCard)
        Map<String, HandRank> ranks = new HashMap<>();
        Map<String, Integer> modScores = new HashMap<>();
        for (ClientHandler p : players) {
            Hand h = playerHands.get(p.username);
            if (h != null) {
                HandRank hr = h.getRank();
                ranks.put(p.username, hr);
                if (hr.getCategory() == 1) { // HighCard
                    modScores.put(p.username, computeModScore(h));
                }
            }
        }
        // Broadcast toÃ n bá»™ bÃ i cá»§a táº¥t cáº£ ngÆ°á»i chÆ¡i
        // Hiá»ƒn thá»‹ bÃ i cá»§a Táº¤T Cáº¢ ngÆ°á»i chÆ¡i cÃ²n láº¡i Ä‘á»ƒ client váº½ lÃªn 3 Ã´ cá»§a tá»«ng vá»‹
        // trÃ­
        StringBuilder showAll = new StringBuilder("SHOW_HANDS_ALL|");
        for (ClientHandler p : players) {
            Hand h = playerHands.get(p.username);
            if (h != null) {
                showAll.append(p.username).append("=").append(h.toShortString()).append("|");
            } else {
                showAll.append(p.username).append("=").append("").append("|");
            }
        }
        broadcast(showAll.toString());

        // XÃ¡c Ä‘á»‹nh ngÆ°á»i tháº¯ng: Æ°u tiÃªn category trÆ°á»›c, náº¿u HighCard thÃ¬ so modulo rá»“i
        // tie-break báº±ng HandRank
        String winner = null;
        HandRank winnerRank = null;
        int winnerModScore = -1; // Chá»‰ dÃ¹ng khi HighCard
        for (String user : ranks.keySet()) {
            HandRank hr = ranks.get(user);
            int ms = hr.getCategory() == 1 ? modScores.getOrDefault(user, -1) : -1;
            if (winner == null) {
                winner = user;
                winnerRank = hr;
                winnerModScore = ms;
                continue;
            }
            if (hr.getCategory() > winnerRank.getCategory()) {
                winner = user;
                winnerRank = hr;
                winnerModScore = ms;
            } else if (hr.getCategory() == winnerRank.getCategory()) {
                if (hr.getCategory() == 1) { // HighCard
                    if (ms > winnerModScore || (ms == winnerModScore && hr.compareTo(winnerRank) > 0)) {
                        winner = user;
                        winnerRank = hr;
                        winnerModScore = ms;
                    }
                } else { // Special hand tie-break
                    if (hr.compareTo(winnerRank) > 0) {
                        winner = user;
                        winnerRank = hr;
                        winnerModScore = ms;
                    }
                }
            }
        }

        // Cáº­p nháº­t Ä‘iá»ƒm sá»‘
        int numPlayers = ranks.size();
        // Sá»‘ ngÆ°á»i thá»±c sá»± tham gia (ká»ƒ cáº£ ngÆ°á»i timeout)
        int totalParticipants = numPlayers + timeoutPlayers.size();

        if (winner != null && totalParticipants > 1) {
            // NgÆ°á»i tháº¯ng nháº­n Ä‘iá»ƒm = (tá»•ng sá»‘ ngÆ°á»i tham gia - 1)
            // Ká»ƒ cáº£ ngÆ°á»i Ä‘Ã£ bá»‹ timeout
            int winnerPoints = totalParticipants - 1;

            // Khá»Ÿi táº¡o Ä‘iá»ƒm cho ngÆ°á»i chÆ°a cÃ³
            for (String user : ranks.keySet()) {
                Server.playerScores.putIfAbsent(user, 0);
            }

            // Cáº­p nháº­t Ä‘iá»ƒm tháº¯ng
            Server.playerScores.put(winner, Server.playerScores.get(winner) + winnerPoints);

            // NgÆ°á»i thua (chÆ°a bá»‹ timeout) bá»‹ trá»« 1
            for (String user : ranks.keySet()) {
                if (!user.equals(winner)) {
                    Server.playerScores.put(user, Server.playerScores.get(user) - 1);
                }
            }

            // Persist point changes to DB
            if (db != null) {
                Integer winId = db.getPlayerId(winner);
                if (winId != null)
                    db.updateTotalPoints(winId, winnerPoints);
                for (String user : ranks.keySet()) {
                    if (!user.equals(winner)) {
                        Integer pid = db.getPlayerId(user);
                        if (pid != null)
                            db.updateTotalPoints(pid, -1);
                    }
                }
                // NgÆ°á»i timeout Ä‘Ã£ bá»‹ trá»« Ä‘iá»ƒm tá»« trÆ°á»›c, khÃ´ng cáº§n trá»« ná»¯a
            }
        }

        // Gá»­i thÃ´ng tin chi tiáº¿t vá» tay bÃ i vÃ  Ä‘iá»ƒm thay Ä‘á»•i
        // Format: HAND_RANKS|user1:category:categoryName:score|user2:...
        StringBuilder handRanksMsg = new StringBuilder("HAND_RANKS|");
        for (String user : ranks.keySet()) {
            HandRank hr = ranks.get(user);
            int displayScore = (hr.getCategory() == 1) ? modScores.getOrDefault(user, 0) : hr.toCompositeScore();
            String categoryName = hr.getCategoryName();
            handRanksMsg.append(user).append(":").append(hr.getCategory())
                    .append(":").append(categoryName).append(":").append(displayScore).append("|");
        }
        broadcast(handRanksMsg.toString());

        if (winner != null) {
            if (winnerRank.getCategory() == 1) {
                broadcast("WINNER " + winner + " tay=HighCard Ä‘iá»ƒm=" + winnerModScore);
            } else {
                broadcast("WINNER " + winner + " tay=" + winnerRank.getCategoryName());
            }
        }

        // Gá»­i báº£ng xáº¿p háº¡ng theo thá»© tá»± tay bÃ i (ngÆ°á»i tháº¯ng trÃªn cÃ¹ng)
        // Format: RANKING|user1:totalPoints:changePoints|user2:...
        StringBuilder ranking = new StringBuilder("RANKING|");

        // Sáº¯p xáº¿p theo thá»© háº¡ng tay bÃ i trong vÃ¡n nÃ y (winner Ä‘áº§u tiÃªn)
        List<String> sortedPlayers = new ArrayList<>(ranks.keySet());
        sortedPlayers.sort((u1, u2) -> {
            HandRank hr1 = ranks.get(u1);
            HandRank hr2 = ranks.get(u2);

            // So sÃ¡nh category trÆ°á»›c
            if (hr1.getCategory() != hr2.getCategory()) {
                return hr2.getCategory() - hr1.getCategory(); // Category cao hÆ¡n lÃªn trÆ°á»›c
            }

            // CÃ¹ng category
            if (hr1.getCategory() == 1) { // HighCard - so modulo
                int mod1 = modScores.getOrDefault(u1, 0);
                int mod2 = modScores.getOrDefault(u2, 0);
                if (mod1 != mod2) {
                    return mod2 - mod1; // Modulo cao hÆ¡n lÃªn trÆ°á»›c
                }
                return hr2.compareTo(hr1); // Tie-break
            } else { // Special hand
                return hr2.compareTo(hr1); // compareTo cao hÆ¡n lÃªn trÆ°á»›c
            }
        });

        for (int i = 0; i < sortedPlayers.size(); i++) {
            String user = sortedPlayers.get(i);
            int totalPts = Server.playerScores.getOrDefault(user, 0);
            int change = user.equals(winner) ? (totalParticipants - 1) : -1;
            ranking.append(user).append(":").append(totalPts).append(":").append(change).append("|");
        }
        broadcast(ranking.toString());

        // LÆ°u MatchResults vÃ o DB (sáº¯p xáº¿p theo thá»© háº¡ng tay bÃ i)
        if (db != null && matchId != null) {
            for (int i = 0; i < sortedPlayers.size(); i++) {
                String user = sortedPlayers.get(i);
                Hand h = playerHands.get(user);
                HandRank r = ranks.get(user);
                Integer pid = db.getPlayerId(user);
                if (pid != null && h != null && r != null) {
                    int scoreVal = (r.getCategory() == 1) ? modScores.getOrDefault(user, 0) : r.toCompositeScore();
                    db.insertMatchResult(matchId, pid, i + 1, scoreVal, r.getCategoryName(), h.toShortString());
                }
            }
            Integer winPid = winner != null ? db.getPlayerId(winner) : null;
            db.endMatch(matchId, winPid);
        }

        broadcast("END;" + roomName);
        // Keep players in room with busy status so they can ready again
        synchronized (players) {
            for (ClientHandler c : players) {
                c.setStatus("busy");
                playerReady.put(c.username, false); // Reset ready cho vÃ¡n má»›i
            }
        }
        // Reset draw state for next round
        playerHands.clear();
        drawCounts.clear();
        broadcastReadyStatus(); // ThÃ´ng bÃ¡o tráº¡ng thÃ¡i ready má»›i

        // Broadcast danh sÃ¡ch ngÆ°á»i chÆ¡i Ä‘á»ƒ cáº­p nháº­t Ä‘iá»ƒm má»›i cho lobby
        Server.broadcastPlayerList();

        System.out.println("ğŸ VÃ²ng rÃºt bÃ i káº¿t thÃºc trong " + roomName + ", sáºµn sÃ ng cho vÃ¡n má»›i.");
    }

    // TÃ­nh tá»•ng Ä‘iá»ƒm 3 lÃ¡ % 10: A=1; J=11; Q=12; K=13; cÃ²n láº¡i sá»‘ tá»± nhiÃªn
    private int computeModScore(Hand h) {
        int sum = 0;
        for (Card c : h.getCards()) {
            String r = c.getRank();
            int val;
            switch (r) {
                case "A":
                    val = 1;
                    break;
                case "J":
                    val = 11;
                    break;
                case "Q":
                    val = 12;
                    break;
                case "K":
                    val = 13;
                    break;
                default:
                    try {
                        val = Integer.parseInt(r);
                    } catch (NumberFormatException ex) {
                        val = 0;
                    }
            }
            sum += val;
        }
        return sum % 10; // 0..9
    }

    // Kick ngÆ°á»i chÆ¡i (chá»‰ host má»›i Ä‘Æ°á»£c kick, vÃ  chá»‰ khi chÆ°a chÆ¡i)
    public void kickPlayer(String targetUsername, ClientHandler requester) {
        // TÃ¬m target player trong synchronized block
        ClientHandler targetPlayer = null;
        boolean isHost = false;

        synchronized (this) {
            // KhÃ´ng cho kick khi game Ä‘ang cháº¡y
            if (gameStarted) {
                requester.sendMessage("KICK_BLOCKED;KhÃ´ng thá»ƒ kick khi Ä‘ang chÆ¡i");
                return;
            }
            int requesterIndex = players.indexOf(requester);
            if (requesterIndex != hostIndex) {
                requester.sendMessage("NOT_HOST");
                return;
            }

            isHost = true;
            for (ClientHandler player : players) {
                if (player.username.equals(targetUsername)) {
                    targetPlayer = player;
                    break;
                }
            }
        }

        // Thá»±c hiá»‡n external calls bÃªn ngoÃ i synchronized block Ä‘á»ƒ trÃ¡nh deadlock
        if (isHost && targetPlayer != null) {
            targetPlayer.resetCurrentRoom();
            targetPlayer.sendMessage("KICKED;Bá»‹ chá»§ phÃ²ng kick");
            removePlayer(targetPlayer);
            System.out.println("ğŸ‘¢ " + targetUsername + " bá»‹ kick bá»Ÿi " + requester.username);

            // Broadcast danh sÃ¡ch ngÆ°á»i chÆ¡i online Ä‘á»ƒ cáº­p nháº­t cho lobby
            Server.broadcastPlayerList();
            // Broadcast danh sÃ¡ch phÃ²ng Ä‘á»ƒ cáº­p nháº­t sá»‘ ngÆ°á»i chÆ¡i
            Server.broadcastRoomsList();
        }
    }

    // Láº¥y thÃ´ng tin phÃ²ng Ä‘á»ƒ hiá»ƒn thá»‹
    public synchronized String getRoomInfo() {
        return roomName + "|" + players.size() + "/" + MAX_PLAYERS;
    }
}